extends layout

block content
    meta(name="csrf-token", content=csrfToken)
    script.
        var interval = undefined;
        function progress(){
            var ids= $(".page").map(function() {
                return $(this).attr("value");
            }).get();
            var token = document.querySelector('meta[name="csrf-token"]').getAttribute('content')
            //console.log(ids);
            $.ajax({
                type: 'POST',
                url: 'progress',
                headers: {  
                    'CSRF-Token': token
                },  
                data: {
                   pageId: ids
                }
            }).then(function(result){
                $('#progress').replaceWith($('#progress', result));
                if($('#completed').text()==='completed'){
                  clearInterval(interval);
                }
            });
        };
        interval = setInterval(function () {progress()}, 2000);
        
    #progress
      if completed===true
        button.btn.btn-success
          span#completed completed
      else
        button.btn.btn-danger Loading..
          span#completed.spinner-border.spinner-border-sm
      if webpages
        if webpages.length
          table.table.table-striped.table-bordered.table-hover.table-sm
            tr.thead-light.d-flex
              th.col-5 input
              th.col-4 result
              th.col-3 capture
            each webpage in webpages
              tr.d-flex.page(value=webpage._id)
                td.col-5
                  .row
                    .col-12
                      h6 url: 
                        a(href=rootPath + "search/page?input=" + encodeURIComponent(webpage.input)) üîç #{webpage.input}

                  .row
                    .col-3 createdAt
                    .col-9
                      a= moment(webpage.createdAt).fromNow()
                  .row
                    if webpage.option
                      each value, key in webpage.option
                        if value
                          .col-3 #{key}
                          .col-9 #{value}                      
                td.col-4
                  .row                    
                    .col-12
                        if webpage._id
                          h5 id: 
                            a(href=rootPath + "page/" +webpage._id) #{webpage._id}

                  .row
                    .col-2 url
                    .col-10
                      if webpage.url
                        a(href=rootPath + "search/page?url=" + webpage.url) üîç #{webpage.url}
                  .row
                    .col-2 title
                    .col-10
                      if webpage.title
                        a(href=rootPath + "search/page?title=" +webpage.title) üîç #{webpage.title}

                  .row
                    .col-2 size
                    .col-10
                      if webpage.content
                        a= webpage.content.length
                  .row
                    .col-2 status
                    .col-10
                      if webpage.status
                        a= webpage.status
                  .row
                    .col-2 ip
                    .col-10
                      if webpage.remoteAddress
                        a= webpage.remoteAddress.ip
                      if webpage.remoteAddress.geoip
                        if webpage.remoteAddress.geoip[0]
                          a= " (" + webpage.remoteAddress.geoip[0].country + ")"
                  .row
                    .col-2 error
                    .col-10
                      if webpage.error
                        a= webpage.error

                td.col-3
                  if webpage.thumbnail
                    a.colorbox(href=rootPath + "screenshot/" +webpage.screenshot)
                      img(src="data:image/png;base64," + webpage.thumbnail)
